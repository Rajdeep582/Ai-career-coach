@Library('Shared') _

pipeline{

    agent any

    environment{
        SONAR_HOME= tool "sonar"
    }

    // Building with Parameters

    parameters{

        string(name: 'FRONTEND_DOCKER_TAG',defaultValue: '', description: 'Setting docker image for latest push')
        string(name: 'BACKEND_DOCKER_TAG',defaultValue: '', description: 'Setting docker image for latest push')
    }


    stages{

        //Validate Parameters

        stage("Validate Parameters"){
            steps{
                script{
                    if (params.FRONTEND_DOCKER_TAG == '' || params.BACKEND_DOCKER_TAG == ''){
                        error("FRONTEND_DOCKER_TAG and BACKEND_DOCKER_TAG is must be provided..")
                    }

                }
            }
        }

        stage("Workspace Cleanup"){
            steps{
                script{
                    echo "Cleaning the Workspace Before Proceeding"
                    cleanWs()
                }
                
            }
        }


        stage("Git: Clone"){
            steps{
                script{
                    code_clone("https://github.com/Shubhankar-24x/Ai-career-coach.git", "main")
                }

            }
        }

        
        stage("Trivy: Filesystem Scanning"){
            steps{
                script{
                    trivy_scan()
                }
            }
        }

        stage("OWASP: Dependency Check"){
            steps{
                script{
                    owasp_dependency_check()
                }
            }
        }

        stage("SonarQube: Code Analysis"){
            steps{
                script{
                    sonarqube_analysis("Sonar","career-coach","career-coach")
                }
            }
        }

        stage("SonarQube: Code Quality Gates"){
            steps{
                script{
                    sonarqube_code_quality()
                }
            }
        }


        stage('Code Linting') {
            steps {
                script {
                    sh 'npm run lint' // Run linting script to check errors 
                }
            }
        }


        stage("Docker: Build Images"){
            steps{
                script{
                    docker_build("career-coach-test", "${params.FRONTEND_DOCKER_TAG}", "shubhankar24")

                   // docker_build("career-coach-test", "${params.BACKEND_DOCKER_TAG}", "shubhankar24")
                }
            }
        }

        stage("Docker Build & Deploy"){
            steps{
                script{
                    sh "docker compose down && docker compose up -d "
                }
            }
        }



    }
}